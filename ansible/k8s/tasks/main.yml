---
# tasks file for k8s_create_cluster

- name: Check if Kubernetes is already initialized
  stat:
    path: /etc/kubernetes/admin.conf
  register: k8s_initialized
  changed_when: false

- name: Initialize the Kubernetes cluster using kubeadm
  become: yes
  command: kubeadm init --pod-network-cidr=192.168.0.0/16 --ignore-preflight-errors=all
  when: not k8s_initialized.stat.exists
  register: kubeadm_init_result
  retries: 3
  delay: 10
  ignore_errors: true

- name: Reset Kubernetes if initialization failed
  become: yes
  shell: |
    kubeadm reset -f
    rm -rf /etc/kubernetes/
    rm -rf ~/.kube/
  when: kubeadm_init_result is failed
  ignore_errors: true

- name: Retry kubeadm init after reset
  become: yes
  command: kubeadm init --pod-network-cidr=192.168.0.0/16
  when: kubeadm_init_result is failed
  register: kubeadm_retry_result

- name: Set up kubeconfig for root
  become: yes
  shell: |
    mkdir -p /root/.kube
    cp -f /etc/kubernetes/admin.conf /root/.kube/config
  when: kubeadm_init_result is succeeded or kubeadm_retry_result is succeeded

- name: Set up kubeconfig for ubuntu user
  become: yes
  shell: |
    mkdir -p /home/ubuntu/.kube
    cp -f /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
    chown -R ubuntu:ubuntu /home/ubuntu/.kube
  when: kubeadm_init_result is succeeded or kubeadm_retry_result is succeeded

- name: Install Calico pod network
  become: yes
  shell: |
    kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
  when: kubeadm_init_result is succeeded or kubeadm_retry_result is succeeded
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

- name: Remove all taints from master node (for single-node cluster)
  become: yes
  shell: |
    # Удаляем все возможные варианты taint
    kubectl taint nodes --all node-role.kubernetes.io/master- 2>/dev/null || true
    kubectl taint nodes --all node-role.kubernetes.io/control-plane- 2>/dev/null || true
    kubectl taint nodes --all node-role.kubernetes.io/controlPlane- 2>/dev/null || true
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  ignore_errors: true
  changed_when: false

- name: Generate join command
  become: yes
  shell: kubeadm token create --print-join-command
  when: kubeadm_init_result is succeeded or kubeadm_retry_result is succeeded
  register: kubernetes_join_command
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

- name: Save join command to file
  become: yes
  copy:
    content: "{{ kubernetes_join_command.stdout }}"
    dest: /tmp/kubernetes_join_command
    mode: '0644'

- name: Copy join command to local machine
  fetch:
    src: /tmp/kubernetes_join_command
    dest: "{{ playbook_dir }}/kubernetes_join_command.txt"
    flat: true
    fail_on_missing: false

- name: Display join command
  debug:
    msg: "Join command: {{ kubernetes_join_command.stdout }}"
  when: kubernetes_join_command is defined

- name: Copy service YAML file
  become: yes
  copy:
    src: "{{ playbook_dir }}/k8s/svc.yaml"
    dest: /home/ubuntu/svc.yaml
    owner: ubuntu
    group: ubuntu
    mode: '0644'